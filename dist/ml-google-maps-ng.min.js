!function(){"use strict";angular.module("ml.google-maps",[])}(),function(){"use strict";function e(e,n,t,o){return this.bounds_=e,this.map_=n,this.count_=t,this.icon_=o,this.div_=null,this.setMap(n),this}e.prototype=new google.maps.OverlayView,e.prototype.onAdd=function(){var e=document.createElement("div");e.className="map-cluster-icon icon"+this.icon_,e.innerHTML="<span>"+this.count_+"</span>",this.div_=e;var n=this.getPanes();n.overlayLayer.appendChild(e)},e.prototype.draw=function(){var e=this.getProjection(),n=e.fromLatLngToDivPixel(this.bounds_.getCenter()),t=30+10*(""+this.count_).length,o=this.div_;o&&(o.style.left=Math.round(n.x-t/2)+"px",o.style.top=Math.round(n.y-t/2)+"px",o.style.width=t+"px",o.style.height=t+"px",o.style.lineHeight=t+"px",o.style.backgroundSize="100%")},e.prototype.onRemove=function(){this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)},angular.module("ml.google-maps").directive("mlSearchMap",["$timeout",function(e){return{restrict:"E",controller:"MLSearchMapController",scope:{map:"=map",options:"=options",facets:"=facets",markers:"=markers",overlayOptions:"=overlayOptions",overlays:"=overlays",selections:"=selections",parentBoundsChanged:"&boundsChanged",parentShowResult:"&showResult",parentShowContextMenu:"&showContextMenu"},templateUrl:"ml-search-map-dir.html",link:function(n,t,o,a){n.$watch("$parent."+o.facets,function(e){e&&a.repaintMap(e)}),n.dragend=function(){n.options.center.lat()!==n.map.getCenter().lat()&&n.options.center.lng()!==n.map.getCenter().lng()&&(n.options.center=n.map.getCenter(),n.parentBoundsChanged({bounds:n.map.getBounds()}))},n.zoomChanged=function(){n.options.zoom!==n.map.getZoom()&&(n.options.zoom=n.map.getZoom(),n.parentBoundsChanged({bounds:n.map.getBounds()}))},n.maptypeidChanged=function(){n.options.mapTypeId!==n.map.getMapTypeId()&&(n.options.mapTypeId=n.map.getMapTypeId())},n.rightclick=function(){n.parentShowContextMenu&&n.parentShowContextMenu()},n.overlayComplete=function(e){n.parentBoundsChanged({bounds:e.overlay.getBounds()})},n.$watch("$parent."+o.options+".center",function(t){t&&n.map&&e(function(){google.maps.event.trigger(n.map,"resize"),n.map.setCenter(t)},0,!1)}),n.$watch("$parent."+o.options+".zoom",function(t){t&&n.map&&e(function(){google.maps.event.trigger(n.map,"resize"),n.map.setZoom(t)},0,!1)}),n.$watch("$parent."+o.options+".mapTypeId",function(t){t&&n.map&&e(function(){n.map.setMapTypeId(t)},0,!1)}),n.showResult=function(e){return n.parentShowResult({uri:e})}}}}]).controller("MLSearchMapController",["$scope","$timeout",function(n,t){function o(e){var t,o,a=0;for(t in e)o=e[t],o&&o.boxes&&(a++,angular.forEach(o.boxes,function(e,t){n.markers.push(r(e,t,a))}))}function a(){n.markers&&(angular.forEach(n.markers,function(e,n){e.setMap(null)}),n.markers.length=0)}function r(t,o,a){var r=new google.maps.LatLngBounds(new google.maps.LatLng(t.s,t.w),new google.maps.LatLng(t.n,t.e));return 1===t.count&&t.uri?new google.maps.Marker({position:r.getCenter(),map:n.map,title:t.uri,icon:"/images/map/p"+a+".png"}):new e(r,n.map,t.count,a)}function i(){n.map&&(google.maps.event.trigger(n.map,"resize"),n.options&&n.map.setCenter(n.options.center))}var s={};angular.extend(s,n.options),this.repaintMap=function(e){!function(e){t(function(){a(),n.overlays&&0===n.overlays.length&&angular.forEach(n.overlayOptions,function(e,t){var o=new google.maps.GroundOverlay(e.image,e.bounds);o.setMap(n.map),n.overlays.push(o)}),o(e,r),n.drawingManager||(n.drawingManager=new google.maps.drawing.DrawingManager({drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.RECTANGLE]},markerOptions:{icon:"images/beachflag.png"},circleOptions:{fillColor:"#ffff00",fillOpacity:1,strokeWeight:5,clickable:!1,editable:!0,zIndex:1}}),n.drawingManager.setMap(n.map),google.maps.event.addListener(n.drawingManager,"overlaycomplete",function(e){n.selections.push(e.overlay),n.overlayComplete(e)}))},100)}(e)},n.openMarkerInfo=function(e){n.currentMarker=e,n.currentMarkerLat=e.getPosition().lat(),n.currentMarkerLng=e.getPosition().lng(),n.myInfoWindow.open(n.map,e)},n.setMarkerPosition=function(e,n,t){e.setPosition(new google.maps.LatLng(n,t))},n.$on("searchmap.refresh",function(){t(function(){i()},0,!1)}),function(){t(function(){i()},1e3,!1),t(function(){i()},2e3,!1),t(function(){i()},4e3,!1)}()}])}(),function(){"use strict";angular.module("ml.google-maps").filter("hasBoxes",function(){return function(e,n){var t=[];return angular.forEach(e,function(e){e&&e.boxes&&t.push(e)}),t}}).directive("mlSearchMapLegend",[function(){return{restrict:"E",scope:{facets:"=facets"},templateUrl:"ml-search-map-legend-dir.html",link:function(e,n,t){}}}])}();