<h1 class="page-header">Quickstart</h1>

<div class="row">
    <div class="col-md-12">
        <p>
            To start using Google Maps for MarkLogic, follow these simple steps to get started.
            <!--Once you're up and running, visit the <a ui-sref="api">API documentation</a> to learn how to get the most out of it.-->
        </p>

        <h3>For use with slush-marklogic-node</h3>
        <p>The <a href="https://github.com/marklogic-community/slush-marklogic-node">slush-marklogic-node</a> has been optimized to make pulling in components like this as easy as possible</p>

        <ol class="steps">
            <!-- 1 -->
            <li>
                <div hljs no-escape language="bash">bower install --save ml-google-maps-ng</div>
            </li>

            <!-- 2 -->
            <li>
                <p>
                  Include this at the end of the <code>&lt;head&gt;</code> of <code>ui/index.html</code>:
                </p>
                <div hljs no-escape language="html" source="'<script src=\'//maps.googleapis.com/maps/api/js?v=3.&libraries=drawing&sensor=false\'></script>'">
                </div>
            </li>

            <!-- 3 -->
            <li>
                <p>
                  Include <code>'ml.google-maps'</code> as a module dependency in for instance <code>ui/app/search/search.module.js</code>:
                </p>
                <div hljs no-escape language="js">angular.module('app.search', [..., 'ml.google-maps']);
</div>
            </li>
            
            <!-- 4 -->
            <li>
                <p>
                  Edit <code>ui/app/search/search.controller.js</code>, and add:
                </p>
                <pre hljs no-escape language="js">

SearchCtrl.$inject = [..., '$state', 'MLQueryBuilder'];

function SearchCtrl(..., $state, qb) {
  ...

  var initMapOptions = {
    center: new $window.google.maps.LatLng(0, 0),
    zoom: 2,
    mapTypeId: $window.google.maps.MapTypeId.ROADMAP
  };

  ctrl.myMap = {
    map: null,
    options: angular.extend({}, initMapOptions),
    markers: [],
    selections: []
  };

  ctrl.boundsChanged = function() {
    // can get triggered at initial setZoom..
    if (newBounds) {

      // This expects a google.maps.LatLng object
      var south = newBounds.getSouthWest().lat();
      var west = newBounds.getSouthWest().lng();
      var north = newBounds.getNorthEast().lat();
      var east = newBounds.getNorthEast().lng();

      ctrl.bounds = {
        'south': south,
        'west': west,
        'north': north,
        'east': east
      };

      ctrl.mlSearch.clearAdditionalQueries();
      ctrl.mlSearch.addAdditionalQuery(
        qb.or(
          // This assumes a geo facet called `Locations`.
          // Repeat following line for each geo facet in the app.
          qb.ext.geospatial('Locations', ctrl.bounds)
        )
      );

      ctrl.search();
    }
  };

  ctrl.resetMap = function() {
    ctrl.myMap.options = angular.extend({}, initMapOptions);
    angular.forEach(ctrl.myMap.selections, function(overlay, index) {
      overlay.setMap(null);
    });
    ctrl.myMap.selections.length = 0;
  };

  ctrl.showResult = function(result) {
    var uri = result.uri || result;
    $state.go('root.view', { uri: uri });
  };
}
</pre>
                <!--p class="muted">
                    Note: this is the very minimum set of properties required for the map to work.
                    See the <a ui-sref="api">API documentation</a> for the full list of supported properties.
                </p-->
            </li>

            <!-- 5 -->
            <li>
                <p>
                  Add a <code>&lt;ml-google-search-map&gt;</code> and a <code>&lt;ml-google-search-map-legend&gt;</code> element in your template like so:
                </p>
                <pre hljs no-escape language="html">
&lt;ml-google-search-map map="$ctrl.myMap.map" options="$ctrl.myMap.options"
            facets="$ctrl.response.facets" markers="$ctrl.myMap.markers" bounds-changed="$ctrl.boundsChanged(bounds)"
            show-result="$ctrl.showResult(uri)" show-context-menu="$ctrl.resetMap()" selections="$ctrl.myMap.selections">
&lt;/ml-google-search-map>

&lt;ml-google-search-map-legend facets="$ctrl.response.facets">&lt;/ml-google-search-map-legend></pre>
            </li>

            <!-- 6 -->
            <li>
                <p>
                  Optionally override the height via CSS for the map container:
                </p>
                <div hljs no-escape language="css">.map-canvas { height: 400px !important; }</div>
                <!--div hljs no-escape language="css">.angular-google-map-container { height: 400px; }</div-->
            </li>
        </ol>

        <h4>Improved zooming behavior (for slush-marklogic-node)</h4>

        <p>By default MarkLogic applies a fixed heatmap grid to come up with aggregate results. There is a custom facet though that improves this.</p>

        <ol class="steps">
            <!-- 1 -->
            <li>
              <p>Disable search options validation, edit <code>rest-api/config/properties.xml</code>, and change the validate-options setting to false. Run <code>./ml local deploy rest</code> to apply.</p>
            </li>

            <!-- 2 -->
            <li>
              <p>Download <a href="geo.xqy">geo.xqy</a>, and copy into <code>src/constraint/</code></p>
            </li>

            <!-- 3 -->
            <li>
              <p>Edit your existing geospatial facet, and wrap it in a custom constraint as follows:</p>
<div hljs no-escape language="xml">  <constraint name="Locations">
    &lt;custom>
      &lt;parse apply="parse-structured" ns="http://marklogic.com/appservices/viz/geo" at="/constraint/geo.xqy"/>
      &lt;start-facet apply="start" ns="http://marklogic.com/appservices/viz/geo" at="/constraint/geo.xqy"/>
      &lt;finish-facet apply="finish" ns="http://marklogic.com/appservices/viz/geo" at="/constraint/geo.xqy"/>
    &lt;/custom>
    &lt;annotation>
       &lt;-- insert original range definition here -->
    &lt;/annotation>
  &lt;/constraint></div>
</li>

          <!-- 4 -->
          <li>
            <p>Edit <code>ui/app/search/search.controller.js</code>, and replace:</p>
<pre hljs no-escape language="js">
  qb.ext.geospatial('Locations', ctrl.bounds)
</pre>
            <p>with:</p>
<pre hljs no-escape language="js">
  qb.ext.custom('Locations', qb.ext.geospatialValues(ctrl.bounds))
</pre>
          </li>
        </ol>

        <h3>Generic steps</h3>

        <ol class="steps">
            <!-- 1 -->
            <li>
                <p>
                    Download <a href="https://raw.github.com/grtjn/ml-google-maps-ng/master/dist/ml-google-maps-ng.js">ml-google-maps-ng.js</a>
                    (<a href="https://raw.github.com/grtjn/ml-google-maps-ng/master/dist/ml-google-maps-ng.min.js">minified version</a>) and put it with your other scripts.
                    Alternatively, you can use Bower to install it automatically:
                </p>
                <div hljs no-escape language="bash">bower install [--save] ml-google-maps-ng</div>
                <p>
                    Or if you prefer bleeding edge:
                </p>
                <div hljs no-escape language="bash">bower install [--save] git@github.com:grtjn/ml-google-maps-ng.git</div>
                <!-- current code still depends on angular-ui-map -->
                <p>
                  If not using Bower, you'll also need to fetch <a href="https://github.com/angular-ui/ui-utils/tree/v0.2.3" rel="external">ui-utils.js (v0.2.3)</a>, and <a href="https://github.com/angular-ui/ui-map/tree/v0.5.0" rel="external">ui-map.js (v0.5.0)</a> yourself.
                </p>
                <!-- replace above with this once we switch to angular-google-maps -->
                <!--p>
                  If not using Bower, you'll also need to fetch <a href="http://lodash.com/" rel="external">lodash.js</a>, and <a href="http://github.com/angular-ui/angular-google-maps" rel="external">angular-google-maps.js</a> yourself.
                </p-->
            </li>

            <!-- 2 -->
            <li>
                <!-- current code still depends on angular-ui-map -->
                <p>
                  Load ui-utils.js, ui-map.js, and ml-google-maps-ng.js into your HTML page (typically in the end of the <em>BODY</em> of your HTML):
                </p>
                <pre hljs no-escape language="html">
&lt;script src='/bower_components/angular-ui-utils/ui-utils[.min].js'>&lt;/script>
&lt;script src='/bower_components/angular-ui-map/ui-map[.min].js'>&lt;/script>
&lt;script src='/bower_components/ml-google-maps-ng/dist/ml-google-maps-ng[.min].js'>&lt;/script></pre>
                <!-- replace above with this once we switch to angular-google-maps -->
                <!--p>Load lodash.js, angular-google-maps.js, and ml-google-maps-ng.js into your HTML page:</p>
                <div hljs no-escape language="html" source="'<script src=\'/bower_components/lodash/lodash[.min].js\'></script>\n<script src=\'/bower_components/angular-google-maps/dist/angular-google-maps[.min].js\'></script>\n<script src=\'/bower_components/ml-google-maps-ng/dist/ml-google-maps-ng[.min].js\'></script>'">
                </div-->
                <p class="text-muted">
                  Note: You can simplify this by making use of <a href="https://www.npmjs.com/package/wiredep" rel="external">wiredep</a>, optionally together with <a href="https://www.npmjs.com/package/gulp-useref" rel="external">gulp-useref</a>.
                </p>
            </li>
            
            <!-- 3 -->
            <li>
                <p>
                  Include the Google Maps API v3, via<!-- one of two ways-->:
                </p>
                <ul>
                    <!-- not available with angular-ui-map -->
                    <!--li>
                        <p><a href="#!/api#GoogleMapApi">Google Maps SDK Async Loader</a> <span class="badge badge-info">New in v2.0.0</span></p>
                        <p>This is the <span class="label label-success">RECOMMENDED</span> way, as it tries to guarantee that Google Maps is ready prior to running any Google dependencies.</p>
                    </li-->
                    <li>
                        <p>
                          Directly load into your HTML page. Example:
                        </p>
                        <div hljs no-escape language="html" source="'<script src=\'//maps.googleapis.com/maps/api/js?v=3.&libraries=drawing&sensor=false\'></script>'">
                        </div>
                        <p class="text-muted">
                            Note: If you go down this route, ensure that it is loaded prior to angular-google-maps.js! The easiest way to do this is to put loading the google maps api in the HTML head, and all angular code in the HTML body.
                        </p>
                    </li>
                </ul>
                <strong>Serving Google Maps in China</strong>
                <p>
                    It is a state demand that all online map providers must use an obscured coordinate system called GCJ-02 (aka Coordinates on Mars).
                    GCJ-02 is WSG-84 based, but added offsets to both latitude and longitude.
                </p>
                <p>
                    If you display a marker from GCJ-02 coordinates on a GCJ-02 map, the place will be marked correctly.<br>
                    However the offsets can result in a less-than-100 up to 700 meter error from the actual location if you place a GCJ-02 marker on a WSG-84 map and vice versa.
                </p>
                <p>
                    There is an <a href="https://github.com/googollee/eviltransform" target="_blank">open-source project</a> that can provide approximate translation between GCJ-02 and WSG-84.
                </p>
                <p>
                    Google also submits to this regulation. They serve this modified system at maps.google.cn. <!--br>
                    Specify a <code>china</code> flag when you load the Google Maps API using the GoogleMapsApi Loader like so:<br>
                <div hljs language="js">
angular.module('myApplicationModule', ['ml-google-maps-ng']).config(
    ['uiGmapGoogleMapApiProvider', function(GoogleMapApiProviders) {
        GoogleMapApiProvider.configure({
            china: true
        });
    }]
);
                </div-->
                    <!--Alternatively i-->If you manually load the Google Maps API, replace <code>//maps.googleapis.com/maps/api/js</code> with
                        <code>http://maps.google.cn/maps/api/js</code>.
                </p>
            </li>

            <!-- 4 -->
            <li>
                <!-- current code still depends on angular-ui-map -->
                <p>
                  Load ml-google-maps-ng.css into your HTML page (typically in the end of the <em>HEAD</em> of your HTML):
                </p>
                <pre hljs no-escape language="html">
&lt;link rel="stylesheet" href="/bower_components/ml-google-maps-ng/dist/ml-google-maps-ng.css"></pre>
                <p class="text-muted">
                  Note: You can simplify this by making use of <a href="https://www.npmjs.com/package/wiredep" rel="external">wiredep</a>, optionally together with <a href="https://www.npmjs.com/package/gulp-useref" rel="external">gulp-useref</a>.
                </p>
                <p class="text-muted">
                  Note: If you go down the route of using gulp-useref, you will likely need to copy images to a folder that is publicly accessible as /images/, otherwise images for the map markers cannot be found by the directive.
                </p>
            </li>
            
            <!-- 5 -->
            <li>
                <p>
                  Make your application module depend on the <code>ml-google-maps-ng</code> module:
                </p>
                <div hljs no-escape language="js">angular.module('myApplicationModule', ['ml.google-maps']);</div>
            </li>
            
            <!-- 6 -->
            <li>
                <p>
                  Expose objects and call-back functions in your Angular controller:
                </p>
                <pre hljs no-escape language="js">
MyCtrl.$inject = ['$scope'];
function MyCtrl($scope) {
  var ctrl = this;

  var initMapOptions = {
    center: new $window.google.maps.LatLng(52.3881895, 4.8447237),
    zoom: 10,
    mapTypeId: $window.google.maps.MapTypeId.ROADMAP
  };

  ctrl.myMap = {
    map: null,
    options: angular.extend({}, initMapOptions),
    markers: [],
    selections: []
  };

  ctrl.myFacets = {
    facets: {
      locations: {
        count: 4262,
        boxes: [{
          count: 625,
          s: 52.28889,
          w: 4.856865,
          n: 52.33222,
          e: 5.019565
        }, {
          count: 1301,
          s: 52.33256,
          w: 4.763993,
          n: 52.40219,
          e: 4.844532
        }, {
          count: 2336,
          s: 52.33251,
          w: 4.844792,
          n: 52.42354,
          e: 5.025896
        }]
      }
    }
  };

  ctrl.boundsChanged = function() {
    // place your geospatial search code here, and make that update $scope.myFacets
  };

  ctrl.resetMap = function() {
    ctrl.myMap.options = angular.extend({}, initMapOptions);
    angular.forEach(ctrl.myMap.selections, function(overlay, index) {
      overlay.setMap(null);
    });
    ctrl.myMap.selections.length = 0;
  };

  ctrl.showResult = function(uri) {
    $window.alert('You clicked ' + uri);
  };
}
</pre>
                <!--p class="muted">
                    Note: this is the very minimum set of properties required for the map to work.
                    See the <a ui-sref="api">API documentation</a> for the full list of supported properties.
                </p-->
            </li>

            <!-- 7 -->
            <li>
                <p>
                  Add a <code>&lt;ml-google-search-map&gt;</code> and a <code>&lt;ml-google-search-map-legend&gt;</code> element in your template like so:
                </p>
                <pre hljs no-escape language="html">
&lt;ml-google-search-map map="myMap.map" options="myMap.options"
            facets="myFacets.facets" markers="myMap.markers" bounds-changed="boundsChanged(bounds)"
            show-result="showResult(uri)" show-context-menu="resetMap()" selections="myMap.selections">
&lt;/ml-google-search-map>

&lt;ml-google-search-map-legend facets="myFacets.facets">&lt;/ml-google-search-map-legend></pre>
            </li>

            <!-- 8 -->
            <li>
                <p>
                  Optionally override the height via CSS for the map container:
                </p>
                <div hljs no-escape language="css">.map-canvas { height: 400px !important; }</div>
                <!--div hljs no-escape language="css">.angular-google-map-container { height: 400px; }</div-->
            </li>
        </ol>
    </div>
</div>